name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add VPS to known_hosts
      run: |
        ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

    # Step to install dependencies and run linting
    - name: Install dependencies and run lint
      run: |
        npm install
        # npm run lint  # Uncomment if you have linting setup

    - name: Deploy to VPS
      run: |
        if [ "${{ github.ref_name }}" == "main" ]; then
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
            set -e  # Exit on error
            
            cd /var/www/orrel-admin-backend
            
            # Pull latest changes
            git fetch origin
            git reset --hard origin/main
            
            # Install dependencies
            npm install --omit=dev
            
            # Copy environment file if exists
            if [ -f .env.prod ]; then
              cp .env.prod .env
              echo '‚úÖ .env.prod copied to .env'
            else
              echo '‚ÑπÔ∏è .env.prod not found, using existing .env'
            fi
            
            # Deploy with PM2
            echo 'üöÄ Deploying with PM2...'
            pm2 delete orrel-admin-backend 2>/dev/null || echo '‚ÑπÔ∏è No existing process to delete'
            pm2 start server.js --name orrel-admin-backend
            pm2 save
            echo '‚úÖ Deployment completed successfully!'
          "
        fi