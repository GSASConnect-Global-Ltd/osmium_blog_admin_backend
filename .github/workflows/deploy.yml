name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add VPS to known_hosts
      run: |
        ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

    # Step to install dependencies and run linting
    - name: Install dependencies and run lint
      run: |
        npm install
        # npm run lint  # Uncomment if you have linting setup

    - name: Deploy to VPS
      run: |
        if [ "${{ github.ref_name }}" == "main" ]; then
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
            cd /var/www/orrel-admin-backend &&
            git pull origin main &&
            npm install --omit=dev &&
            cp .env.prod .env &&
            pm2 reload server.js --name orrel-admin-backend --update-env || pm2 start server.js --name orrel-admin-backend
            pm2 save
          "
        fi