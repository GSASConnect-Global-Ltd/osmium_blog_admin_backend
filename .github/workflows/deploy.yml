# name: Deploy to VPS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v2

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.5.3
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#     # Step to install dependencies and run linting
#     - name: Install dependencies and run lint
#       run: |
#         npm install
#         # npm run lint  # Uncomment if you have linting setup

#     - name: Deploy to VPS
#       run: |
#         if [ "${{ github.ref_name }}" == "main" ]; then
#           ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e  # Exit on error
            
#             cd /var/www/orrel-admin-backend
            
#             # Pull latest changes
#             git fetch origin
#             git reset --hard origin/main
            
#             # Install dependencies
#             npm install --omit=dev
            
#             # Copy environment file if exists
#             if [ -f .env.prod ]; then
#               cp .env.prod .env
#               echo 'âœ… .env.prod copied to .env'
#             else
#               echo 'â„¹ï¸ .env.prod not found, using existing .env'
#             fi
            
#             # Deploy with PM2
#             echo 'ðŸš€ Deploying with PM2...'
#             pm2 delete orrel-admin-backend 2>/dev/null || echo 'â„¹ï¸ No existing process to delete'
#             pm2 start server.js --name orrel-admin-backend
#             pm2 save
#             echo 'âœ… Deployment completed successfully!'
#           "
#         fi


# name: Deploy Express App
# on:
#   push:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.5
#       with:
#         host: ${{ secrets.VPS_IP }}
#         port: 22222
#         username: gsas-admin
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           cd /srv/orrel-admin-backend
#           git pull origin main
#           npm install --production
#           # [ -f .env.dev ] && cp .env.dev .env
#           pm2 restart orrel-admin-backend 2>/dev/null || \
#           pm2 start npm --name 'orrel-admin-backend' -- start
#           pm2 save
#           echo 'âœ… Orrel Admin Express app deployed!'


# name: Deploy Express App Securely
# on:
#   push:
#     branches: [main]

# jobs:
#   security-scan:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
      
#       - name: Scan for secrets with TruffleHog
#         uses: trufflesecurity/trufflehog@main
#         with:
#           path: ./
#           base: ${{ github.event.repository.default_branch }}
#           head: HEAD
          
#       - name: NPM Audit
#         run: npm audit --production

#   deploy:
#     runs-on: ubuntu-latest
#     needs: security-scan
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Deploy to VPS
#       uses: appleboy/ssh-action@v0.1.5
#       with:
#         host: ${{ secrets.VPS_IP }}
#         port: 22222
#         username: admin-gsas  # âœ… CORRECTED
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           set -e  # Exit on error
          
#           # === SECURITY CHECKS ===
#           echo "ðŸ”’ Starting secure deployment..."
          
#           # Define paths
#           APP_NAME="orrel-admin-backend"
#           APP_DIR="/srv/$APP_NAME"
#           BACKUP_DIR="/home/admin-gsas/backups"
#           LOG_DIR="/var/log/$APP_NAME"
          
#           # 1. Verify directory exists
#           if [ ! -d "$APP_DIR" ]; then
#             echo "âŒ App directory not found. Creating..."
#             sudo mkdir -p "$APP_DIR"
#             sudo chown admin-gsas:admin-gsas "$APP_DIR"
#           fi
          
#           cd "$APP_DIR"
          
#           # 2. Backup current version FIRST
#           echo "ðŸ“¦ Creating backup..."
#           TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#           sudo mkdir -p "$BACKUP_DIR"
#           sudo tar czf "$BACKUP_DIR/${APP_NAME}_$TIMESTAMP.tar.gz" . 2>/dev/null || true
          
#           # 3. Create isolated deployment
#           echo "ðŸ—ï¸ Setting up isolated deployment..."
#           DEPLOY_TEMP="/tmp/${APP_NAME}_deploy_$TIMESTAMP"
#           mkdir -p "$DEPLOY_TEMP"
          
#           # 4. Copy existing configs to preserve
#           if [ -f ".env" ]; then
#             cp .env "$DEPLOY_TEMP/"
#           fi
          
#           # 5. Pull fresh code to temp location
#           echo "â¬‡ï¸ Pulling fresh code..."
#           cd "$DEPLOY_TEMP"
#           git clone https://github.com/GSASConnect-Global-Ltd/osmium_blog_admin_backend.git . --branch main --depth 1
          
#           # 6. Restore environment config
#           if [ -f "../.env" ]; then
#             cp "../.env" .
#           fi
          
#           # 7. SECURE npm install with audit
#           echo "ðŸ” Running security checks..."
#           npm ci --only=production --audit
          
#           # 8. Verify no suspicious packages
#           echo "ðŸ”Ž Scanning for suspicious files..."
#           SUSPICIOUS_FILES=$(find node_modules -name "*.js" -type f -exec grep -l "eval(\|child_process\|spawn\|wget\|curl" {} \; 2>/dev/null | head -5)
#           if [ ! -z "$SUSPICIOUS_FILES" ]; then
#             echo "âŒ Suspicious files detected!"
#             echo "$SUSPICIOUS_FILES"
#             exit 1
#           fi
          
#           # 9. Move to production location (atomic operation)
#           echo "ðŸšš Deploying to production..."
#           cd "$APP_DIR/.."
#           sudo rm -rf "${APP_DIR}_old" 2>/dev/null || true
#           sudo mv "$APP_DIR" "${APP_DIR}_old"
#           sudo mv "$DEPLOY_TEMP" "$APP_DIR"
#           sudo chown -R admin-gsas:admin-gsas "$APP_DIR"
          
#           # 10. Setup log directory
#           sudo mkdir -p "$LOG_DIR"
#           sudo chown admin-gsas:admin-gsas "$LOG_DIR"
          
#           # 11. Restart with PM2
#           echo "ðŸ”„ Restarting application..."
#           cd "$APP_DIR"
          
#           # Check if PM2 is installed
#           if ! command -v pm2 &> /dev/null; then
#             echo "ðŸ“¦ Installing PM2..."
#             npm install -g pm2
#           fi
          
#           # Restart or start
#           pm2 delete "$APP_NAME" 2>/dev/null || true
#           pm2 start npm --name "$APP_NAME" -- start
#           pm2 save
#           pm2 startup 2>/dev/null || true
          
#           # 12. Cleanup old backups (keep last 5)
#           echo "ðŸ§¹ Cleaning up old backups..."
#           cd "$BACKUP_DIR"
#           ls -t ${APP_NAME}_*.tar.gz | tail -n +6 | xargs -r rm
          
#           # 13. Remove old deployment
#           sudo rm -rf "${APP_DIR}_old" 2>/dev/null || true
          
#           echo "âœ… Deployment completed successfully!"
#           echo "ðŸ“Š Application status:"
#           pm2 status

# name: Deploy to VPS Securely
# on:
#   push:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
      
#       - name: Quick Security Check
#         run: |
#           # Quick check for obvious secrets
#           if grep -r "AKIA[0-9A-Z]\{16\}\|sk_live_[0-9a-zA-Z]\{24\}" --include="*.js" --include="*.json" . 2>/dev/null; then
#             echo "âŒ SECURITY ALERT: Secrets found in code!"
#             exit 1
#           fi
#           echo "âœ… Basic security check passed"
      
#       - name: Deploy to Server
#         uses: appleboy/ssh-action@v0.1.5
#         with:
#           host: ${{ secrets.VPS_IP }}
#           port: 22222
#           username: ${{ secrets.VPS_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             set -e  # Exit on any error
            
#             echo "ðŸ”’ Starting secure deployment..."
            
#             # Configuration
#             APP_NAME="orrel-admin-backend"
#             APP_DIR="/srv/$APP_NAME"
#             BACKUP_DIR="/home/admin-gsas/backups/$APP_NAME"
#             TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
#             # 1. Ensure directory exists with correct permissions
#             echo "ðŸ“ Setting up directories..."
#             sudo mkdir -p "$APP_DIR"
#             sudo chown admin-gsas:admin-gsas "$APP_DIR"
#             sudo chmod 755 "$APP_DIR"
            
#             mkdir -p "$BACKUP_DIR"
            
#             cd "$APP_DIR"
            
#             # 2. Backup current version
#             echo "ðŸ“¦ Creating backup..."
#             if [ -d ".git" ]; then
#               tar czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" . 2>/dev/null || echo "Warning: Backup creation failed"
#             fi
            
#             # 3. Update code with error handling
#             echo "â¬‡ï¸ Updating code..."
#             if [ -d ".git" ]; then
#               git fetch origin
#               git reset --hard origin/main
#             else
#               # First time deployment
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#               git fetch origin
#               git reset --hard origin/main
#             fi
            
#             # 4. Restore environment file from backup if exists
#             if [ -f "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" ] && [ ! -f ".env" ]; then
#               echo "ðŸ”„ Restoring .env from backup..."
#               tar -xzf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" .env 2>/dev/null || true
#             fi
            
#             # 5. Secure dependency installation
#             echo "ðŸ“¦ Installing dependencies securely..."
#             rm -rf node_modules package-lock.json
#             npm ci --only=production --audit
            
#             # 6. Quick security scan of node_modules
#             echo "ðŸ” Scanning dependencies..."
#             SUSPICIOUS_COUNT=$(find node_modules -name "*.js" -type f -exec grep -l "eval(\|child_process\.exec\|wget\|curl" {} \; 2>/dev/null | wc -l)
#             if [ "$SUSPICIOUS_COUNT" -gt 10 ]; then
#               echo "âš ï¸  Warning: Found $SUSPICIOUS_COUNT suspicious files"
#             fi
            
#             # 7. Restart application
#             echo "ðŸ”„ Restarting application..."
            
#             # Check if PM2 is installed
#             if ! command -v pm2 &> /dev/null; then
#               echo "ðŸ“¦ Installing PM2..."
#               npm install -g pm2
#             fi
            
#             # Delete old process if exists
#             pm2 delete "$APP_NAME" 2>/dev/null || true
            
#             # Start new process
#             pm2 start npm --name "$APP_NAME" -- start
            
#             # Save PM2 process list
#             pm2 save
            
#             # 8. Setup PM2 startup on boot (if not already)
#             pm2 startup 2>/dev/null || echo "PM2 startup already configured"
            
#             # 9. Cleanup old backups (keep last 7)
#             echo "ðŸ§¹ Cleaning up old backups..."
#             cd "$BACKUP_DIR"
#             ls -t backup_*.tar.gz 2>/dev/null | tail -n +8 | xargs -r rm -f || true
            
#             echo "âœ… Deployment completed successfully!"
#             echo "ðŸ“Š App status:"
#             pm2 status "$APP_NAME"

# name: Deploy to VPS
# on:
#   push:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
      
#       - name: Deploy to Server
#         uses: appleboy/ssh-action@v0.1.5
#         with:
#           host: ${{ secrets.VPS_IP }}
#           port: 22222
#           username: ${{ secrets.VPS_USER }}  # Make sure this is correct
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             set -e
            
#             APP_NAME="orrel-admin-backend"
#             APP_DIR="/srv/$APP_NAME"
#             BACKUP_DIR="/home/admin-gsas/backups"
            
#             # Create backup directory
#             mkdir -p "$BACKUP_DIR"
            
#             cd "$APP_DIR"
            
#             # Backup current
#             echo "Creating backup..."
#             tar czf "$BACKUP_DIR/${APP_NAME}_$(date +%s).tar.gz" . 2>/dev/null || true
            
#             # Update code
#             echo "Pulling latest code..."
#             git fetch origin
#             git reset --hard origin/main
            
#             # Secure npm install
#             echo "Installing dependencies..."
#             rm -rf node_modules
#             npm ci --only=production --audit
            
#             # Check if PM2 is installed - FIXED SYNTAX
#             if ! command -v pm2 &> /dev/null; then
#               echo "Installing PM2..."
#               npm install -g pm2
#             fi
            
#             # Delete old process if exists
#             pm2 delete "$APP_NAME" 2>/dev/null || true
            
#             # Start new process - FIXED: -- start (with space)
#             pm2 start npm --name "$APP_NAME" -- start
            
#             # Save PM2 process list
#             pm2 save
            
#             # Setup PM2 startup on boot (if not already)
#             pm2 startup 2>/dev/null || echo "PM2 startup already configured"
            
#             # Cleanup old backups (keep last 7) - FIXED PATH
#             echo "Cleaning up old backups..."
#             cd "$BACKUP_DIR"
#             ls -t ${APP_NAME}_*.tar.gz 2>/dev/null | tail -n +8 | xargs -r rm -f || true
            
#             echo "Deployment completed successfully!"
#             echo "App status:"
#             pm2 status "$APP_NAME"

# name: Deploy to VPS
# on:
#   push:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
      
#       - name: Deploy to Server
#         uses: appleboy/ssh-action@v0.1.5
#         with:
#           host: ${{ secrets.VPS_IP }}
#           port: 22222
#           timeout: 30s
#           username: ${{ secrets.VPS_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             set -e  # Exit immediately on any error
            
#             # =================================================================
#             # CONFIGURATION - SET ABSOLUTE PATHS
#             # =================================================================
#             NODE_PATH="/home/admin-gsas/.nvm/versions/node/v24.13.0/bin/node"
#             NPM_PATH="/home/admin-gsas/.nvm/versions/node/v24.13.0/bin/npm"
#             APP_NAME="orrel-admin-backend"
#             APP_DIR="/srv/$APP_NAME"
#             BACKUP_DIR="/home/admin-gsas/backups"
#             # =================================================================
            
#             echo "ðŸš€ Starting deployment of $APP_NAME..."
#             echo "Using Node.js: $($NODE_PATH --version)"
#             echo "Using npm: $($NPM_PATH --version)"
            
#             # 1. Create backup directory if it doesn't exist
#             mkdir -p "$BACKUP_DIR"
            
#             # 2. Navigate to app directory
#             cd "$APP_DIR"
#             echo "Working in: $(pwd)"
            
#             # 3. Create backup of current version
#             echo "ðŸ“¦ Creating backup..."
#             TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#             tar czf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" . 2>/dev/null || echo "Note: No files to backup (first deployment?)"
            
#             # 4. Update code from GitHub
#             echo "â¬‡ï¸ Pulling latest code..."
            
#             # Check if this is a git repository
#             if [ -d ".git" ]; then
#               git fetch origin
#               git reset --hard origin/main
#               echo "Code updated successfully"
#             else
#               # First time deployment - clone the repository
#               echo "First deployment detected, initializing git repository..."
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#               git fetch origin
#               git reset --hard origin/main
#             fi
            
#             # 5. Restore .env file from backup if it exists
#             if [ ! -f ".env" ] && [ -f "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" ]; then
#               echo "ðŸ”§ Restoring .env from backup..."
#               tar -xzf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" .env 2>/dev/null || echo "No .env in backup"
#             fi
            
#             # 6. Install/update dependencies
#             echo "ðŸ“¦ Installing dependencies..."
#             rm -rf node_modules package-lock.json
#             $NPM_PATH ci --only=production --audit
            
#             # 7. Setup PM2 process manager
#             echo "âš™ï¸ Setting up PM2..."
            
#             # Check if PM2 is installed
#             if ! command -v pm2 &> /dev/null; then
#               echo "Installing PM2 globally..."
#               $NPM_PATH install -g pm2
#             fi
            
#             # 8. Restart application with PM2
#             echo "ðŸ”„ Restarting application..."
            
#             # Stop existing process if running
#             pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process to delete"
            
#             # Start new process
#             # Adjust the start command based on your package.json
#             # Option A: If package.json has "start" script
#             pm2 start $NPM_PATH --name "$APP_NAME" -- run start
            
#             # Option B: If you need to run a specific file
#             # pm2 start $NODE_PATH --name "$APP_NAME" -- server.js
            
#             # 9. Save PM2 configuration
#             pm2 save
            
#             # 10. Setup PM2 to start on boot (if not already)
#             echo "ðŸ”§ Setting up startup configuration..."
#             pm2 startup 2>/dev/null || echo "PM2 startup already configured"
            
#             # 11. Cleanup old backups (keep last 5)
#             echo "ðŸ§¹ Cleaning up old backups..."
#             cd "$BACKUP_DIR"
#             ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f || echo "No old backups to clean"
            
#             # 12. Verify deployment
#             echo "âœ… Deployment completed!"
#             echo ""
#             echo "ðŸ“Š Application Status:"
#             pm2 status "$APP_NAME"
#             echo ""
#             echo "ðŸ“ Recent logs:"
#             pm2 logs "$APP_NAME" --lines 5 --silent 2>/dev/null || echo "No logs available yet"
            
#             # 13. Health check (optional)
#             echo ""
#             echo "ðŸ¥ Running health check..."
#             sleep 3
#             if pm2 ping "$APP_NAME" 2>/dev/null; then
#               echo "âœ… Application is running and responsive"
#             else
#               echo "âš ï¸  Application may need manual checking"
#             fi

# name: Deploy to VPS
# on:
#   push:
#     branches: [main]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
      
#       - name: Deploy to Server
#         uses: appleboy/ssh-action@v0.1.5
#         with:
#           host: ${{ secrets.VPS_IP }}
#           port: 22222
#           username: admin-gsas
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           script: |
#             set -e  # Exit on any error
            
#             echo "ðŸš€ Starting deployment..."
            
#             # =================================================================
#             # CRITICAL FIX: Ensure node is in PATH for all processes
#             # =================================================================
#             # Create symlink to make node available system-wide
#             sudo ln -sf "/home/admin-gsas/.nvm/versions/node/v24.13.0/bin/node" /usr/bin/node 2>/dev/null || true
            
#             # Also add to /usr/local/bin (common alternative)
#             sudo ln -sf "/home/admin-gsas/.nvm/versions/node/v24.13.0/bin/node" /usr/local/bin/node 2>/dev/null || true
            
#             # Set PATH for this session and all child processes
#             export PATH="/home/admin-gsas/.nvm/versions/node/v24.13.0/bin:$PATH"
            
#             # Verify
#             echo "Node.js version: $(node --version)"
#             echo "npm version: $(npm --version)"
#             echo "Node path: $(which node)"
#             # =================================================================
            
#             # Configuration
#             APP_NAME="orrel-admin-backend"
#             APP_DIR="/srv/$APP_NAME"
#             BACKUP_DIR="/home/admin-gsas/backups"
            
#             # Create backup directory
#             mkdir -p "$BACKUP_DIR"
            
#             # Navigate to app directory
#             cd "$APP_DIR"
#             echo "Working directory: $(pwd)"
            
#             # Backup current version
#             echo "ðŸ“¦ Creating backup..."
#             TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#             tar czf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" . 2>/dev/null || echo "No files to backup (first deployment?)"
            
#             # Update code from GitHub
#             echo "â¬‡ï¸ Pulling latest code..."
#             if [ -d ".git" ]; then
#               git fetch origin
#               git reset --hard origin/main
#               echo "âœ… Code updated successfully"
#             else
#               echo "First deployment - initializing git..."
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#               git fetch origin
#               git reset --hard origin/main
#             fi
            
#             # Restore .env file from backup if needed
#             if [ ! -f ".env" ] && [ -f "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" ]; then
#               echo "ðŸ”§ Restoring .env from backup..."
#               tar -xzf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" .env 2>/dev/null || echo "No .env in backup"
#             fi
            
#             # Install dependencies
#             echo "ðŸ“¦ Installing dependencies..."
#             rm -rf node_modules package-lock.json
            
#             # Use npm ci with production flag
#             npm ci --only=production --audit
            
#             echo "âœ… Dependencies installed"
            
#             # Setup PM2 process manager
#             echo "âš™ï¸ Setting up PM2..."
#             if ! command -v pm2 &> /dev/null; then
#               echo "Installing PM2..."
#               npm install -g pm2
#             fi
            
#             # Restart application
#             echo "ðŸ”„ Restarting application..."
            
#             # Delete existing process if running
#             pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process to delete"
            
#             # Start new process
#             # IMPORTANT: Check your package.json for the correct start command
#             # Common options:
#             # 1. If package.json has "start" script: npm run start
#             # 2. If main file is server.js: node server.js
#             # 3. If using a specific script: npm run prod
            
#             pm2 start npm --name "$APP_NAME" -- run start
            
#             # Save PM2 configuration
#             pm2 save
            
#             # Setup PM2 to start on boot
#             echo "ðŸ”§ Setting up startup configuration..."
#             pm2 startup 2>/dev/null || echo "PM2 startup already configured"
            
#             # Cleanup old backups (keep last 5)
#             echo "ðŸ§¹ Cleaning up old backups..."
#             cd "$BACKUP_DIR"
#             ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f || echo "No old backups to clean"
            
#             # Final status
#             echo ""
#             echo "ðŸŽ‰ Deployment completed successfully!"
#             echo ""
#             echo "ðŸ“Š Application Status:"
#             pm2 status "$APP_NAME"
#             echo ""
#             echo "ðŸ“ Recent logs (last 3 lines):"
#             pm2 logs "$APP_NAME" --lines 3 --silent 2>/dev/null || echo "No logs available yet"

name: Deploy to VPS
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_IP }}
          port: 22222
          username: admin-gsas
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on any error
            
            echo "ðŸš€ Starting deployment..."
            
            # =================================================================
            # CRITICAL FIX: Ensure node is in PATH
            # =================================================================
            sudo ln -sf "/home/admin-gsas/.nvm/versions/node/v24.13.0/bin/node" /usr/bin/node 2>/dev/null || true
            sudo ln -sf "/home/admin-gsas/.nvm/versions/node/v24.13.0/bin/node" /usr/local/bin/node 2>/dev/null || true
            export PATH="/home/admin-gsas/.nvm/versions/node/v24.13.0/bin:$PATH"
            # =================================================================
            
            # Configuration
            APP_NAME="orrel-admin-backend"
            APP_DIR="/srv/$APP_NAME"
            BACKUP_DIR="/home/admin-gsas/backups"
            
            # Create backup directory
            mkdir -p "$BACKUP_DIR"
            
            # Navigate to app directory
            cd "$APP_DIR"
            echo "Working directory: $(pwd)"
            
            # Backup current version
            echo "ðŸ“¦ Creating backup..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            tar czf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" . 2>/dev/null || echo "No files to backup"
            
            # Update code from GitHub
            echo "â¬‡ï¸ Pulling latest code..."
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
              echo "âœ… Code updated successfully"
            else
              echo "First deployment - initializing git..."
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
              git fetch origin
              git reset --hard origin/main
            fi
            
            # Restore .env file from backup if needed
            # if [ ! -f ".env" ] && [ -f "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" ]; then
            #   echo "ðŸ”§ Restoring .env from backup..."
            #   tar -xzf "$BACKUP_DIR/${APP_NAME}_backup_$TIMESTAMP.tar.gz" .env 2>/dev/null || echo "No .env in backup"
            # fi
            
            # Install dependencies
            echo "ðŸ“¦ Installing dependencies..."
            
            # Check if package-lock.json exists
            if [ ! -f "package-lock.json" ]; then
              echo "âš ï¸ package-lock.json not found. Generating it..."
              rm -rf node_modules
              npm install --package-lock-only --omit=dev
            fi
            
            # Clean install with existing package-lock.json
            rm -rf node_modules
            npm ci --omit=dev --audit
            
            echo "âœ… Dependencies installed"
            
            # Setup PM2 process manager
            echo "âš™ï¸ Setting up PM2..."
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              npm install -g pm2
            fi
            
            # Restart application
            echo "ðŸ”„ Restarting application..."
            
            # Delete existing process if running
            pm2 delete "$APP_NAME" 2>/dev/null || echo "No existing process to delete"
            
            # Start new process
            pm2 start npm --name "$APP_NAME" -- run start
            
            # Save PM2 configuration
            pm2 save
            
            # Setup PM2 to start on boot
            echo "ðŸ”§ Setting up startup configuration..."
            pm2 startup 2>/dev/null || echo "PM2 startup already configured"
            
            # Cleanup old backups (keep last 5)
            echo "ðŸ§¹ Cleaning up old backups..."
            cd "$BACKUP_DIR"
            ls -t ${APP_NAME}_backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f || echo "No old backups to clean"
            
            # Final status
            echo ""
            echo "ðŸŽ‰ Deployment completed successfully!"
            echo ""
            echo "ðŸ“Š Application Status:"
            pm2 status "$APP_NAME"